# ðŸš€ Deployment Guide - Render.com

## Prerequisites

1. **GitHub Account** - Your code must be in a GitHub repository
2. **Render Account** - Sign up at [render.com](https://render.com)
3. **Stripe Account** - For payment processing
4. **Email SMTP** - For sending order confirmations

---

## Step 1: Prepare Your Repository

### Push to GitHub

```bash
cd /Users/stefanonozza/Documents/timbrobro
git init
git add .
git commit -m "Initial commit - Timbrobro backend"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/timbrobro.git
git push -u origin main
```

### Create `.gitignore`

Make sure your `.gitignore` includes:
```
.env
.env.local
orders.db
exports/
__pycache__/
*.pyc
.DS_Store
```

---

## Step 2: Deploy to Render

### Option A: Using render.yaml (Recommended)

1. Go to [dashboard.render.com](https://dashboard.render.com)
2. Click **"New +" â†’ "Blueprint"**
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml`
5. Click **"Apply"**

### Option B: Manual Setup

1. Click **"New +" â†’ "Web Service"**
2. Connect GitHub repository
3. Configure:
   - **Name**: `timbrobro-backend`
   - **Region**: Frankfurt (EU)
   - **Branch**: `main`
   - **Runtime**: Python 3
   - **Build Command**: `pip install -r requirements.txt`
   - **Start Command**: `gunicorn --config gunicorn.conf.py server:app`
   - **Plan**: Free

---

## Step 3: Configure Environment Variables

In Render Dashboard â†’ Your Service â†’ Environment:

### Required Variables

```bash
# Admin
ADMIN_TOKEN=your_secure_random_token_here

# Stripe
STRIPE_SECRET_KEY=sk_live_your_stripe_secret_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_stripe_publishable_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# Email (SMTP)
SMTP_EMAIL=orders@gassstro.com
SMTP_PASSWORD=your_smtp_app_password
SMTP_SERVER=mail.gassstro.com
SMTP_PORT=587

# Frontend Domain
ALLOWED_ORIGINS=https://stefanonozza.github.io,https://yourdomain.com
DOMAIN=https://stefanonozza.github.io/timbrobro

# Database (Auto-generated by Render)
DATABASE_URL=postgresql://...  # Automatically set if you created a database
```

### Generate Secure Tokens

```bash
# Generate ADMIN_TOKEN
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

---

## Step 4: Create PostgreSQL Database

1. In Render Dashboard â†’ **"New +" â†’ "PostgreSQL"**
2. Configure:
   - **Name**: `timbrobro-db`
   - **Region**: Frankfurt (same as web service)
   - **Plan**: Free
3. Click **"Create Database"**
4. Copy the **Internal Database URL**
5. Add it to your web service environment as `DATABASE_URL`

---

## Step 5: Configure Stripe Webhooks

1. Go to [Stripe Dashboard â†’ Webhooks](https://dashboard.stripe.com/webhooks)
2. Click **"Add endpoint"**
3. **Endpoint URL**: `https://your-app.onrender.com/api/webhook`
4. **Events to send**:
   - `checkout.session.completed`
5. Copy the **Signing secret** (starts with `whsec_`)
6. Add it to Render environment as `STRIPE_WEBHOOK_SECRET`

---

## Step 6: Update Frontend

Update your frontend code to use the production API:

### In `script.js`:

```javascript
// Change from localhost to production
const API_URL = 'https://your-app.onrender.com';

// Update form submission
fetch(`${API_URL}/api/create-payment`, {
    method: 'POST',
    body: formData
})
```

### Deploy Frontend to GitHub Pages

```bash
# In your repository
git add .
git commit -m "Update API endpoint for production"
git push

# Enable GitHub Pages
# Go to: Repository Settings â†’ Pages â†’ Source: main branch
```

---

## Step 7: Test Everything

### 1. Health Check
```bash
curl https://your-app.onrender.com/api/health
# Should return: {"status":"ok","db":"PostgreSQL"}
```

### 2. Test Order Flow
1. Visit your GitHub Pages site
2. Upload a logo
3. Complete checkout with Stripe test card: `4242 4242 4242 4242`
4. Verify order appears in admin panel

### 3. Test Admin Panel
1. Open `https://your-app.onrender.com/admin.html?token=YOUR_ADMIN_TOKEN`
2. Verify orders are displayed
3. Test filters, search, export

---

## Troubleshooting

### Service Won't Start

Check logs in Render Dashboard â†’ Your Service â†’ Logs

Common issues:
- Missing environment variables
- Database connection failed
- Port binding (Render uses `PORT` env var automatically)

### Database Connection Error

```bash
# Verify DATABASE_URL is set correctly
# Should start with: postgresql://
```

### File Uploads Not Working

Free tier has ephemeral filesystem - files are deleted on restart.
Consider using:
- AWS S3
- Cloudinary
- Render Disks (paid feature)

### Stripe Webhooks Failing

1. Check webhook URL is correct
2. Verify `STRIPE_WEBHOOK_SECRET` is set
3. Check Render logs for webhook errors

---

## Monitoring

### View Logs
```bash
# In Render Dashboard
Your Service â†’ Logs â†’ Live tail
```

### Database Access
```bash
# Connect to PostgreSQL
# In Render Dashboard â†’ Database â†’ Connect
psql postgresql://...
```

---

## Scaling (When Needed)

### Upgrade to Starter Plan ($7/month)
- No sleep after inactivity
- Faster response times
- More resources

### Add Persistent Disk
- For file storage
- $0.25/GB/month

---

## Security Checklist

- [ ] `ADMIN_TOKEN` is strong and secret
- [ ] Stripe keys are in production mode (`sk_live_...`)
- [ ] CORS `ALLOWED_ORIGINS` only includes your domains
- [ ] SMTP credentials are secure
- [ ] Database has strong password
- [ ] HTTPS is enabled (automatic on Render)

---

## Backup Strategy

### Database Backups
Render Free tier includes:
- Daily automatic backups (7 days retention)
- Manual backups via dashboard

### Export Orders Regularly
```bash
# Use the export API
curl -H "X-Admin-Token: YOUR_TOKEN" \
  https://your-app.onrender.com/api/orders/export \
  -o backup_$(date +%Y%m%d).csv
```

---

## Support

- **Render Docs**: https://render.com/docs
- **Render Community**: https://community.render.com
- **Stripe Docs**: https://stripe.com/docs

---

## Next Steps

1. âœ… Deploy backend to Render
2. âœ… Configure environment variables
3. âœ… Set up PostgreSQL database
4. âœ… Configure Stripe webhooks
5. âœ… Update frontend API endpoints
6. âœ… Test complete flow
7. ðŸŽ‰ Launch!
